

<!DOCTYPE html>
<html class="writer-html5" lang="fr" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.components.ingredients_clustering_page &mdash; Documentation Mangetamain 1.0</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=7a28dfa3"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=e6b791cb"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Mangetamain
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">IADATA700_mangetamain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">src</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ClassDiagram.html">Diagramme de classes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Mangetamain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Code du module</a></li>
      <li class="breadcrumb-item active">src.components.ingredients_clustering_page</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de src.components.ingredients_clustering_page</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="sd">&quot;&quot;&quot;Streamlit page: Analyse de co-occurrence et clustering d&#39;ingr√©dients.</span>

<span class="sd">Cette page utilise une matrice de co-occurrence PR√âCALCUL√âE pour optimiser les performances.</span>
<span class="sd">La matrice 300x300 est g√©n√©r√©e √† froid par utils/preprocess_ingredients_matrix.py.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">core.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>


<div class="viewcode-block" id="IngredientsClusteringConfig">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IngredientsClusteringConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration pour l&#39;analyse de clustering d&#39;ingr√©dients.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        matrix_path: Chemin vers la matrice de co-occurrence pr√©calcul√©e.</span>
<span class="sd">        ingredients_list_path: Chemin vers la liste des ingr√©dients.</span>
<span class="sd">        n_ingredients: Nombre d&#39;ingr√©dients √† analyser (de la matrice 300x300).</span>
<span class="sd">        n_clusters: Nombre de clusters √† cr√©er avec K-means.</span>
<span class="sd">        tsne_perplexity: Param√®tre de perplexit√© pour la visualisation t-SNE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">matrix_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/ingredients_cooccurrence_matrix.csv&quot;</span><span class="p">)</span>
    <span class="n">ingredients_list_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/ingredients_list.csv&quot;</span><span class="p">)</span>
    <span class="n">n_ingredients</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">n_clusters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">tsne_perplexity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span></div>



<div class="viewcode-block" id="IngredientsClusteringPage">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IngredientsClusteringPage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Page Streamlit pour l&#39;analyse de clustering des ingr√©dients.</span>

<span class="sd">    Cette classe charge une matrice de co-occurrence PR√âCALCUL√âE et effectue</span>
<span class="sd">    le clustering et la visualisation en temps r√©el.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        matrix_path: Chemin vers la matrice de co-occurrence pr√©calcul√©e.</span>
<span class="sd">        ingredients_list_path: Chemin vers la liste des ingr√©dients.</span>
<span class="sd">        logger: Instance du logger pour le suivi des op√©rations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/ingredients_cooccurrence_matrix.csv&quot;</span><span class="p">,</span>
        <span class="n">ingredients_list_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data/ingredients_list.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise la page de clustering d&#39;ingr√©dients.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix_path: Chemin vers la matrice de co-occurrence pr√©calcul√©e (300x300).</span>
<span class="sd">            ingredients_list_path: Chemin vers la liste des 300 ingr√©dients avec fr√©quences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">matrix_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ingredients_list_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ingredients_list_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing IngredientsClusteringPage with precomputed matrix&quot;</span><span class="p">)</span>

    <span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_spinner</span><span class="o">=</span><span class="s2">&quot;Chargement de la matrice pr√©calcul√©e...&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_cooccurrence_matrix</span><span class="p">(</span><span class="n">_self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Charge et sanitise la matrice de co-occurrence + liste d&#39;ingr√©dients.</span>

<span class="sd">        Sanitation appliqu√©e:</span>
<span class="sd">        - Strip espaces</span>
<span class="sd">        - D√©tection mismatch index/colonnes</span>
<span class="sd">        - For√ßage de la sym√©trie (colonnes = index) si n√©cessaire</span>
<span class="sd">        - Suppression doublons √©ventuels</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple (matrice 300x300 nettoy√©e, liste des ingr√©dients) si succ√®s, None sinon.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_self</span><span class="o">.</span><span class="n">matrix_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Matrice introuvable: </span><span class="si">{</span><span class="n">_self</span><span class="o">.</span><span class="n">matrix_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üí° Ex√©cutez d&#39;abord: `uv run python -m utils.preprocess_ingredients_matrix`&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">cooc_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">_self</span><span class="o">.</span><span class="n">matrix_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Matrice charg√©e brute: </span><span class="si">{</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Validation de forme: la matrice doit √™tre carr√©e et &lt;= 400x400</span>
            <span class="k">if</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;‚ùå Le fichier charg√© n&#39;est pas une matrice de co-occurrence carr√©e valide. V√©rifiez le chemin fourni.&quot;</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Le fichier charg√© n&#39;est pas une matrice de co-occurrence carr√©e. Assurez-vous d&#39;avoir pr√©calcul√© la matrice avec `utils/preprocess_ingredients_matrix.py` et que le chemin est `data/ingredients_cooccurrence_matrix.csv`.&quot;</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Matrice tr√®s grande (</span><span class="si">{</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">); ce n&#39;est probablement pas le fichier pr√©calcul√© attendu.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Normalisation l√©g√®re des labels (mais on conserve casse/minuscule existante)</span>
            <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># V√©rifier sym√©trie des labels</span>
            <span class="n">idx_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">col_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx_set</span> <span class="o">!=</span> <span class="n">col_set</span><span class="p">:</span>
                <span class="n">missing_in_cols</span> <span class="o">=</span> <span class="n">idx_set</span> <span class="o">-</span> <span class="n">col_set</span>
                <span class="n">missing_in_idx</span> <span class="o">=</span> <span class="n">col_set</span> <span class="o">-</span> <span class="n">idx_set</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Mismatch labels: rows_only=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_in_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">, cols_only=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_in_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Intersection pour carr√© coh√©rent</span>
                <span class="n">common</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idx_set</span> <span class="o">&amp;</span> <span class="n">col_set</span><span class="p">)</span>
                <span class="n">cooc_matrix</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common</span><span class="p">,</span> <span class="n">common</span><span class="p">]</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;üîß Matrice r√©duite √† intersection commune: </span><span class="si">{</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Forcer colonnes = index si ordre diff√©rent</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è R√©ordonnancement des colonnes pour correspondre √† l&#39;index&quot;</span><span class="p">)</span>
                <span class="n">cooc_matrix</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="p">[</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

            <span class="c1"># V√©rifier doublons</span>
            <span class="k">if</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">has_duplicates</span> <span class="ow">or</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">has_duplicates</span><span class="p">:</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è Doublons d√©tect√©s dans labels; d√©duplication&quot;</span><span class="p">)</span>
                <span class="c1"># D√©duplication par agr√©gation (somme)</span>
                <span class="n">cooc_matrix</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">cooc_matrix</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="p">[</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># r√©aligner colonnes</span>
                <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;üîÅ Apr√®s d√©duplication: </span><span class="si">{</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;‚úÖ Matrice finalis√©e: </span><span class="si">{</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | Sample: </span><span class="si">{</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_self</span><span class="o">.</span><span class="n">ingredients_list_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Liste des ingr√©dients introuvable: </span><span class="si">{</span><span class="n">_self</span><span class="o">.</span><span class="n">ingredients_list_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">ingredients_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">_self</span><span class="o">.</span><span class="n">ingredients_list_path</span><span class="p">)</span>
            <span class="n">ingredients_list</span><span class="p">[</span><span class="s1">&#39;ingredient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingredients_list</span><span class="p">[</span><span class="s1">&#39;ingredient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;‚úÖ Liste charg√©e: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ingredients_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> ingr√©dients | Top 5: </span><span class="si">{</span><span class="n">ingredients_list</span><span class="o">.</span><span class="n">head</span><span class="p">()[</span><span class="s1">&#39;ingredient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">cooc_matrix</span><span class="p">,</span> <span class="n">ingredients_list</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Erreur de chargement: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load precomputed matrix: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="IngredientsClusteringPage.render_sidebar">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage.render_sidebar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_sidebar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche la sidebar avec les param√®tres de clustering.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionnaire contenant les param√®tres s√©lectionn√©s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;üîß Param√®tres de Clustering&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;üìä Matrice pr√©calcul√©e: 300 ingr√©dients&quot;</span><span class="p">)</span>

        <span class="c1"># Nombre d&#39;ingr√©dients √† s√©lectionner</span>
        <span class="n">n_ingredients</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
            <span class="s2">&quot;Nombre d&#39;ingr√©dients √† analyser&quot;</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;S√©lectionner les N ingr√©dients les plus fr√©quents depuis la matrice 300x300&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Nombre de clusters</span>
        <span class="n">n_clusters</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
            <span class="s2">&quot;Nombre de clusters&quot;</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Nombre de groupes d&#39;ingr√©dients √† cr√©er avec K-means&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Param√®tres t-SNE</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;üé® Visualisation t-SNE&quot;</span><span class="p">)</span>
        <span class="n">tsne_perplexity</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span>
            <span class="s2">&quot;Perplexit√©&quot;</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Contr√¥le la densit√© des groupes (5=local, 50=global)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Bouton d&#39;analyse</span>
        <span class="n">analyze_button</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;üöÄ Lancer l&#39;analyse&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;n_ingredients&quot;</span><span class="p">:</span> <span class="n">n_ingredients</span><span class="p">,</span>
            <span class="s2">&quot;n_clusters&quot;</span><span class="p">:</span> <span class="n">n_clusters</span><span class="p">,</span>
            <span class="s2">&quot;tsne_perplexity&quot;</span><span class="p">:</span> <span class="n">tsne_perplexity</span><span class="p">,</span>
            <span class="s2">&quot;analyze_button&quot;</span><span class="p">:</span> <span class="n">analyze_button</span><span class="p">,</span>
        <span class="p">}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_select_top_ingredients</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cooc_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ingredients_list</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;S√©lectionne robustement les N ingr√©dients les plus fr√©quents.</span>

<span class="sd">        Diagnostic d√©taill√©:</span>
<span class="sd">        - Taille liste vs matrice</span>
<span class="sd">        - Intersections</span>
<span class="sd">        - Fallback si mismatch complet (utilisation directe de l&#39;index matrice)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">matrix_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cooc_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Logs de diagnostic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;üîé Diagnostic s√©lection: matrix_index=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix_index</span><span class="p">)</span><span class="si">}</span><span class="s2">, matrix_cols=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">, list_rows=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ingredients_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">matrix_index</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">matrix_cols</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è Les labels lignes/colonnes ne correspondent pas parfaitement.&quot;</span><span class="p">)</span>

        <span class="n">list_ings</span> <span class="o">=</span> <span class="n">ingredients_list</span><span class="p">[</span><span class="s1">&#39;ingredient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">inter_with_index</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_ings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">matrix_index</span><span class="p">)</span>
        <span class="n">inter_with_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_ings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">matrix_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;üîé Intersections: with_index=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_with_index</span><span class="p">)</span><span class="si">}</span><span class="s2">, with_cols=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_with_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inter_with_index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;‚ùå Aucune intersection entre la liste et l&#39;index de la matrice. Fallback sur index brut.&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback: prendre directement premiers n ingr√©dients de la matrice</span>
            <span class="n">top_final</span> <span class="o">=</span> <span class="n">matrix_index</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_final</span><span class="p">,</span> <span class="n">top_final</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;‚úÖ Fallback utilis√©: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_final</span><span class="p">)</span><span class="si">}</span><span class="s2"> ingr√©dients | shape=</span><span class="si">{</span><span class="n">sub_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sub_matrix</span><span class="p">,</span> <span class="n">top_final</span>

        <span class="c1"># Filtrage selon index (pas colonnes encore)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">ingredients_list</span><span class="p">[</span><span class="n">ingredients_list</span><span class="p">[</span><span class="s1">&#39;ingredient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">matrix_index</span><span class="p">)]</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">)[</span><span class="s1">&#39;ingredient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># V√©rification colonnes</span>
        <span class="n">top_valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">ing</span> <span class="k">for</span> <span class="n">ing</span> <span class="ow">in</span> <span class="n">top</span> <span class="k">if</span> <span class="n">ing</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">matrix_cols</span><span class="p">)]</span>
        <span class="n">lost</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">top_valid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lost</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Ingr√©dients pr√©sents dans index mais absents des colonnes ignor√©s: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">lost</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lost</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">top_final</span> <span class="o">=</span> <span class="n">top_valid</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_final</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Seulement </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_final</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> ingr√©dients disponibles apr√®s filtrage&quot;</span>
            <span class="p">)</span>

        <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">cooc_matrix</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">top_final</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">top_final</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sub_matrix</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è NaN d√©tect√©s dans sous-matrice; remplissage √† 0&quot;</span><span class="p">)</span>
            <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">sub_matrix</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;‚úÖ S√©lection finale: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_final</span><span class="p">)</span><span class="si">}</span><span class="s2"> ingr√©dients | shape=</span><span class="si">{</span><span class="n">sub_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sub_matrix</span><span class="p">,</span> <span class="n">top_final</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Effectue le clustering K-means sur la matrice.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: Matrice de co-occurrence.</span>
<span class="sd">            n_clusters: Nombre de clusters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array des labels de cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing K-means clustering with k=</span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clustering completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span><span class="si">}</span><span class="s2"> unique clusters&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">clusters</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_tsne</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">perplexity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;G√©n√®re la visualisation t-SNE.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: Matrice de co-occurrence.</span>
<span class="sd">            clusters: Labels de cluster.</span>
<span class="sd">            perplexity: Param√®tre de perplexit√©.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict avec coordonn√©es x, y et m√©tadonn√©es.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating t-SNE visualization with perplexity=</span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Ajuster la perplexit√© si n√©cessaire</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">adjusted_perplexity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">adjusted_perplexity</span> <span class="o">!=</span> <span class="n">perplexity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Perplexity adjusted from </span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">adjusted_perplexity</span><span class="si">}</span><span class="s2"> (n_samples=</span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

            <span class="c1"># t-SNE</span>
            <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span>
                <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">perplexity</span><span class="o">=</span><span class="n">adjusted_perplexity</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">coords</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;x_coords&quot;</span><span class="p">:</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;y_coords&quot;</span><span class="p">:</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;ingredient_names&quot;</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;cluster_labels&quot;</span><span class="p">:</span> <span class="n">clusters</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;n_clusters&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clusters</span><span class="p">)),</span>
                <span class="s2">&quot;tsne_params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;perplexity&quot;</span><span class="p">:</span> <span class="n">adjusted_perplexity</span><span class="p">,</span>
                    <span class="s2">&quot;max_iter&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="s2">&quot;random_state&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;tsne&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-SNE failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<div class="viewcode-block" id="IngredientsClusteringPage.render_cooccurrence_analysis">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage.render_cooccurrence_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_cooccurrence_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche l&#39;analyse de co-occurrence interactive.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;üîç Analyse de Co-occurrence&quot;</span><span class="p">)</span>

        <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
            <span class="n">ing1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Premier ingr√©dient&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">ingredient_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
            <span class="n">ing2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
                <span class="s2">&quot;Deuxi√®me ingr√©dient&quot;</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="n">ingredient_names</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">ing1</span> <span class="ow">and</span> <span class="n">ing2</span> <span class="ow">and</span> <span class="n">ing1</span> <span class="o">!=</span> <span class="n">ing2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ing1</span><span class="p">,</span> <span class="n">ing2</span><span class="p">]</span>
                <span class="n">max_score</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">avg_score</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">matrix</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="n">col_m1</span><span class="p">,</span> <span class="n">col_m2</span><span class="p">,</span> <span class="n">col_m3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">col_m1</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Nombre de recettes communes&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">col_m2</span><span class="p">:</span>
                    <span class="n">percentile</span> <span class="o">=</span> <span class="p">(</span><span class="n">score</span> <span class="o">/</span> <span class="n">max_score</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">max_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Percentile&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">percentile</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">col_m3</span><span class="p">:</span>
                    <span class="n">ratio</span> <span class="o">=</span> <span class="n">score</span> <span class="o">/</span> <span class="n">avg_score</span> <span class="k">if</span> <span class="n">avg_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;vs Moyenne&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

                <span class="c1"># Barre de progression</span>
                <span class="k">if</span> <span class="n">max_score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">score</span> <span class="o">/</span> <span class="n">max_score</span><span class="p">)</span>

                <span class="c1"># Interpr√©tation</span>
                <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">avg_score</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;üî• Combinaison tr√®s fr√©quente!&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">avg_score</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Combinaison courante&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;‚ö†Ô∏è Combinaison rare&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;‚ùå Aucune co-occurrence&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IngredientsClusteringPage.render_clusters">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage.render_clusters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_clusters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n_clusters</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche les clusters d&#39;ingr√©dients.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;üéØ Clusters d&#39;Ingr√©dients&quot;</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;üî¥&quot;</span><span class="p">,</span> <span class="s2">&quot;üü†&quot;</span><span class="p">,</span> <span class="s2">&quot;üü°&quot;</span><span class="p">,</span> <span class="s2">&quot;üü¢&quot;</span><span class="p">,</span> <span class="s2">&quot;üîµ&quot;</span><span class="p">,</span> <span class="s2">&quot;üü£&quot;</span><span class="p">,</span> <span class="s2">&quot;‚ö´&quot;</span><span class="p">,</span> <span class="s2">&quot;‚ö™&quot;</span><span class="p">,</span> <span class="s2">&quot;üü§&quot;</span><span class="p">,</span> <span class="s2">&quot;üîò&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
            <span class="n">cluster_ings</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ingredient_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">cluster_id</span>
            <span class="p">]</span>

            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">cluster_id</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>

            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s2"> Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_ings</span><span class="p">)</span><span class="si">}</span><span class="s2"> ingr√©dients)&quot;</span><span class="p">,</span>
                <span class="n">expanded</span><span class="o">=</span><span class="n">cluster_id</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Expand first 2 clusters only</span>
            <span class="p">):</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_ings</span><span class="p">):</span>
                    <span class="n">cols</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚Ä¢ **</span><span class="si">{</span><span class="n">ing</span><span class="si">}</span><span class="s2">**&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IngredientsClusteringPage.render_tsne_visualization">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage.render_tsne_visualization">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_tsne_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsne_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche la visualisation t-SNE.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;üé® Visualisation t-SNE 2D&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">tsne_data</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ùå Erreur t-SNE: </span><span class="si">{</span><span class="n">tsne_data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Cr√©er le graphique</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#FF6B6B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#4ECDC4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#45B7D1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#96CEB4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FFEAA7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#DDA0DD&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#98D8C8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#F7DC6F&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#BB8FCE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#85C1E9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#F8B88B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FAA0A0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#B0E57C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#87CEEB&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#DDA0DD&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#F0E68C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FFB6C1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#20B2AA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FF69B4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#BA55D3&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">n_clusters</span> <span class="o">=</span> <span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cluster_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="o">==</span> <span class="n">cluster_id</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;cluster_labels&quot;</span><span class="p">]]</span>
            <span class="n">cluster_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;x_coords&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">cluster_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;y_coords&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">cluster_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;ingredient_names&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">cluster_id</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">cluster_x</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">cluster_y</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers+text&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">cluster_names</span><span class="p">,</span>
                    <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;top center&quot;</span><span class="p">,</span>
                    <span class="n">textfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cluster_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;%</span><span class="se">{{</span><span class="s2">text</span><span class="se">}}</span><span class="s2">&lt;/b&gt;&lt;br&gt;Cluster: </span><span class="si">{</span><span class="n">cluster_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Visualisation t-SNE des Ingr√©dients&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Dimension 1&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Dimension 2&quot;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(245,245,245,0.8)&quot;</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;‚ÑπÔ∏è √Ä propos de t-SNE&quot;</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            **t-SNE** r√©duit la dimensionnalit√© pour visualiser les similarit√©s entre ingr√©dients.</span>

<span class="sd">            - **Points proches** = ingr√©dients avec profils de co-occurrence similaires</span>
<span class="sd">            - **Couleurs** = clusters K-means</span>
<span class="sd">            - **Distance** = mesure de similarit√© culinaire</span>

<span class="sd">            **Param√®tres utilis√©s**:</span>
<span class="sd">            - Perplexit√©: {}</span>
<span class="sd">            - It√©rations: 1000</span>
<span class="sd">            - Seed: 42</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tsne_data</span><span class="p">[</span><span class="s2">&quot;tsne_params&quot;</span><span class="p">][</span><span class="s2">&quot;perplexity&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="IngredientsClusteringPage.render_sidebar_statistics">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage.render_sidebar_statistics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_sidebar_statistics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche les statistiques dans la sidebar.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;### üìä Statistiques&quot;</span><span class="p">)</span>

        <span class="n">cluster_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Ingr√©dients analys√©s&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">))</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Clusters cr√©√©s&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_counts</span><span class="p">))</span>

        <span class="c1"># Graphique</span>
        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;**R√©partition:**&quot;</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#FF6B6B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#4ECDC4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#45B7D1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#96CEB4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#FFEAA7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#DDA0DD&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#98D8C8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#F7DC6F&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#BB8FCE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;#85C1E9&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_counts</span><span class="p">):</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">count</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                    <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                    <span class="n">marker_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span>
                    <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;outside&quot;</span><span class="p">,</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Nombre&quot;</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_counts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_1_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche l&#39;√©tape 1 : Pr√©traitement NLP des ingr√©dients.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;üìà √âTAPE 1 : Pr√©traitement NLP des ingr√©dients&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Question :** Comment normaliser et regrouper les variantes d&#39;un m√™me ingr√©dient ?</span>

<span class="sd">        Les recettes utilisent des descriptions vari√©es pour un m√™me ingr√©dient (ex: &quot;sel&quot;, &quot;gros sel&quot;,</span>
<span class="sd">        &quot;sel de mer&quot;, &quot;sel fin&quot;). Le pr√©traitement NLP vise √† identifier et regrouper ces variantes</span>
<span class="sd">        pour cr√©er une repr√©sentation coh√©rente.</span>

<span class="sd">        **M√©trique :** Taux de r√©duction du nombre d&#39;ingr√©dients uniques apr√®s normalisation.</span>

<span class="sd">        **üí° Note technique :** Cette √©tape a √©t√© **pr√©calcul√©e √† froid** lors de la g√©n√©ration de la</span>
<span class="sd">        matrice 300√ó300 avec `utils/preprocess_ingredients_matrix.py`. Environ **~230,000 recettes** ont</span>
<span class="sd">        √©t√© trait√©es pour extraire et normaliser les 300 ingr√©dients les plus fr√©quents.</span>

<span class="sd">        **M√©thodologie appliqu√©e :**</span>
<span class="sd">        - Normalisation : minuscules, suppression ponctuation, filtrage stop words</span>
<span class="sd">        - Regroupement : variantes lexicales fusionn√©es</span>
<span class="sd">        - R√©duction typique : ~70% des variantes √©limin√©es</span>

<span class="sd">        **üéØ R√©sultat :** Le pr√©traitement r√©duit significativement la redondance en identifiant</span>
<span class="sd">        les variantes linguistiques d&#39;un m√™me ingr√©dient. Cette √©tape est cruciale pour obtenir une</span>
<span class="sd">        matrice de co-occurrence fiable et permet de concentrer l&#39;analyse sur les v√©ritables patterns</span>
<span class="sd">        culinaires plut√¥t que sur les variations de nomenclature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_2_cooccurrence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche l&#39;√©tape 2 : Cr√©ation de la matrice de co-occurrence.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;üìà √âTAPE 2 : Matrice de co-occurrence&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Objectif :** Quantifier la fr√©quence d&#39;apparition conjointe de chaque paire d&#39;ingr√©dients.</span>

<span class="sd">        La matrice de co-occurrence capture l&#39;information fondamentale : combien de fois deux</span>
<span class="sd">        ingr√©dients apparaissent ensemble dans les recettes. Cette matrice sym√©trique constitue</span>
<span class="sd">        la base de notre analyse de similarit√©.</span>

<span class="sd">        **M√©thode :** Pour chaque recette, toutes les paires d&#39;ingr√©dients pr√©sents sont comptabilis√©es.</span>

<span class="sd">        **üí° Note technique :** Cette matrice **300√ó300** a √©t√© **pr√©calcul√©e √† froid** sur l&#39;ensemble</span>
<span class="sd">        du corpus (~230,000 recettes). Vous s√©lectionnez dynamiquement un sous-ensemble (40-300 ingr√©dients)</span>
<span class="sd">        de cette matrice pour votre analyse.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Statistiques de la matrice</span>
        <span class="n">total_cooccurrences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">non_zero_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">matrix</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">matrix_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">)</span>
        <span class="n">max_possible_pairs</span> <span class="o">=</span> <span class="n">matrix_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">matrix_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">sparsity</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">non_zero_pairs</span> <span class="o">/</span> <span class="n">max_possible_pairs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span><span class="p">,</span> <span class="n">col4</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Dimension matrice&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">matrix_size</span><span class="si">}</span><span class="s2">√ó</span><span class="si">{</span><span class="n">matrix_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Co-occurrences totales&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_cooccurrences</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col3</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Paires non-nulles&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">non_zero_pairs</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col4</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span>
                <span class="s2">&quot;Sparsit√©&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sparsity</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Pourcentage de paires sans co-occurrence&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

        <span class="c1"># Analyse interactive de co-occurrence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_cooccurrence_analysis</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **üìä Ce que r√©v√®le la matrice :**</span>

<span class="sd">        La distribution des co-occurrences n&#39;est pas uniforme. Certaines paires d&#39;ingr√©dients</span>
<span class="sd">        apparaissent ensemble dans des milliers de recettes, r√©v√©lant des associations culinaires</span>
<span class="sd">        fortes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_3_clustering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">n_clusters</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche l&#39;√©tape 3 : Clustering K-means.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;üìà √âTAPE 3 : Clustering K-means&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        **Objectif :** Regrouper automatiquement les ingr√©dients en </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> familles distinctes.</span>

<span class="s2">        L&#39;algorithme K-means partitionne les ingr√©dients en fonction de leurs profils de co-occurrence.</span>
<span class="s2">        Deux ingr√©dients dans le m√™me cluster partagent des contextes d&#39;utilisation similaires, m√™me</span>
<span class="s2">        s&#39;ils ne co-occurrent pas directement.</span>

<span class="s2">        **M√©thode :** K-means avec k=</span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2">, distance euclidienne sur les vecteurs de co-occurrence.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Statistiques des clusters</span>
        <span class="n">cluster_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Nombre de clusters&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
            <span class="n">avg_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_clusters</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Taille moyenne&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">avg_size</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> ingr√©dients&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">col3</span><span class="p">:</span>
            <span class="n">largest_cluster_size</span> <span class="o">=</span> <span class="n">cluster_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;Plus grand cluster&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">largest_cluster_size</span><span class="si">}</span><span class="s2"> ingr√©dients&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>

        <span class="c1"># Affichage des clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        **üéØ Interpr√©tation des clusters :**</span>

<span class="s2">        Les clusters arrivent √† r√©v√©ler des &quot;famille culinaire&quot; d&#39;ingr√©dients. Ils peuvent √™tre :</span>
<span class="s2">        - **Ingr√©dients pour patisserie**</span>
<span class="s2">        - **Produits de recettes sal√©s**</span>

<span class="s2">        **Limite m√©thodologique** : Le choix de k=</span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> est param√©trique. Diff√©rentes valeurs</span>
<span class="s2">        de k r√©v√®lent des structures √† diff√©rentes granularit√©s.</span>
<span class="s2">        De plus, les clusters ont tendance √† ne pas √™tre de la m√™me taille car une masse d&#39;ingr√©dient √† faible co-occurence se regrouppent ensemble.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_step_4_visualization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsne_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche l&#39;√©tape 4 : Visualisation t-SNE 2D.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;üìà √âTAPE 4 : Visualisation t-SNE 2D&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Objectif :** Projeter l&#39;espace haute-dimensionnalit√© des co-occurrences en 2D pour exploration visuelle.</span>

<span class="sd">        La matrice de co-occurrence est un espace √† n dimensions (une par ingr√©dient). t-SNE</span>
<span class="sd">        (t-Distributed Stochastic Neighbor Embedding) r√©duit cette dimensionnalit√© √† 2D tout en</span>
<span class="sd">        pr√©servant les proximit√©s locales.</span>

<span class="sd">        **M√©thode :** t-SNE avec perplexit√© ajust√©e, optimisation par descente de gradient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Visualisation t-SNE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render_tsne_visualization</span><span class="p">(</span><span class="n">tsne_data</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **üîç Lecture de la visualisation :**</span>

<span class="sd">        - **Proximit√© spatiale** : Les ingr√©dients proches dans l&#39;espace 2D ont des profils de</span>
<span class="sd">          co-occurrence similaires (utilis√©s dans des contextes culinaires similaires)</span>
<span class="sd">        - **Couleurs** : Chaque couleur repr√©sente un cluster K-means. La coh√©sion spatiale des</span>
<span class="sd">          couleurs valide la qualit√© du clustering</span>
<span class="sd">        - **Groupes isol√©s** : Les clusters bien s√©par√©s g√©ographiquement indiquent des familles</span>
<span class="sd">          culinaires distinctes</span>

<span class="sd">        **üí° Insights visuels :**</span>

<span class="sd">        La visualisation r√©v√®le souvent une structure non-lin√©aire de l&#39;espace culinaire. Certains</span>
<span class="sd">        ingr√©dients &quot;pont&quot; peuvent se situer entre plusieurs clusters, refl√©tant leur polyvalence</span>
<span class="sd">        (ex: l&#39;huile d&#39;olive utilis√©e dans de multiples contextes, ou l&#39;eau).</span>

<span class="sd">        **Validation du clustering** : Si les couleurs (clusters K-means) forment des groupes</span>
<span class="sd">        visuellement coh√©rents dans l&#39;espace t-SNE, cela confirme que le clustering a captur√©</span>
<span class="sd">        des structures r√©elles plut√¥t qu&#39;artificielles.</span>

<span class="sd">        **Limite de t-SNE** : La repr√©sentation 2D est approximative. Les distances absolues ne</span>
<span class="sd">        sont pas strictement pr√©serv√©es, seules les proximit√©s relatives comptent. Diff√©rentes</span>
<span class="sd">        ex√©cutions peuvent donner des configurations l√©g√®rement diff√©rentes (non-d√©terminisme).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_render_conclusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Affiche la conclusion de l&#39;analyse.&quot;&quot;&quot;</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;üìã Conclusion de l&#39;analyse&quot;</span><span class="p">)</span>

        <span class="c1"># Calculer quelques statistiques finales</span>
        <span class="n">cluster_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">largest_cluster</span> <span class="o">=</span> <span class="n">cluster_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">smallest_cluster</span> <span class="o">=</span> <span class="n">cluster_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ### Synth√®se des r√©sultats</span>

<span class="s2">        **1. Pr√©traitement NLP r√©ussi :** La normalisation automatique a permis de r√©duire</span>
<span class="s2">        significativement la redondance des variantes d&#39;ingr√©dients, cr√©ant une base solide</span>
<span class="s2">        pour l&#39;analyse.</span>

<span class="s2">        **2. Structure r√©v√©l√©e par la co-occurrence :** L&#39;analyse de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">)</span><span class="si">}</span>
<span class="s2">        ingr√©dients a r√©v√©l√© des patterns clairs d&#39;association culinaire, confirmant que la</span>
<span class="s2">        cuisine n&#39;est pas al√©atoire.</span>

<span class="s2">        **3. Clustering coh√©rent :** L&#39;algorithme K-means a identifi√© </span><span class="si">{</span><span class="n">n_clusters</span><span class="si">}</span><span class="s2"> familles</span>
<span class="s2">        d&#39;ingr√©dients distinctes, avec des tailles variant de </span><span class="si">{</span><span class="n">smallest_cluster</span><span class="si">}</span><span class="s2"> √† </span><span class="si">{</span><span class="n">largest_cluster</span><span class="si">}</span>
<span class="s2">        ingr√©dients. Ces clusters essaye de capturer des insight sur le co-usage des ingr√©dients.</span>

<span class="s2">        **4. Validation visuelle :** La projection t-SNE montre la structure des clusters et</span>
<span class="s2">        l&#39;organisation de l&#39;espace culinaire.</span>

<span class="s2">        ### Applications pratiques</span>

<span class="s2">        Ces r√©sultats peuvent √™tre utilis√©s pour :</span>
<span class="s2">        - **Syst√®mes de recommandation** : Sugg√©rer des ingr√©dients compl√©mentaires lors de la</span>
<span class="s2">          cr√©ation de recettes</span>
<span class="s2">        - **Analyse nutritionnelle** : Identifier les associations alimentaires courantes pour</span>
<span class="s2">          des √©tudes di√©t√©tiques, nottament en reliant les informations caloriques</span>
<span class="s2">        - **Cr√©ativit√© culinaire** : D√©couvrir des combinaisons innovantes en explorant les</span>
<span class="s2">          fronti√®res entre clusters</span>
<span class="s2">        - **D√©tection d&#39;anomalies** : Identifier des recettes avec des combinaisons inhabituelles</span>

<span class="s2">        ### Limites et perspectives</span>

<span class="s2">        **Limites :**</span>
<span class="s2">        - La co-occurrence ne capture pas l&#39;ordre ou les quantit√©s des ingr√©dients</span>
<span class="s2">        - Les ingr√©dients tr√®s rares ne sont pas repr√©sent√©s et ceux trop pr√©sent</span>
<span class="s2">        peuvent √™tre mal repr√©sent√©s</span>

<span class="s2">        **Perspectives d&#39;am√©lioration :**</span>
<span class="s2">        - Clustering hi√©rarchique pour r√©v√©ler plusieurs niveaux de granularit√©</span>
<span class="s2">        - Int√©gration d&#39;informations s√©mantiques (cat√©gories nutritionnelles, origines)</span>
<span class="s2">        - Mod√®les de recommandation bas√©s sur les embeddings d&#39;ingr√©dients</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="IngredientsClusteringPage.run">
<a class="viewcode-back" href="../../../api/src.components.html#src.components.ingredients_clustering_page.IngredientsClusteringPage.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Point d&#39;entr√©e principal de la page.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting ingredients clustering analysis with precomputed matrix&quot;</span><span class="p">)</span>

        <span class="c1"># Introduction et User Story</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;üéØ Objectifs et m√©thodologie de l&#39;analyse&quot;</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ### Peut-on regrouper les ingr√©dients selon leurs usages culinaires ?</span>

<span class="sd">            Cette analyse explore les patterns de co-occurrence d&#39;ingr√©dients dans les recettes pour</span>
<span class="sd">            identifier les associations culinaires naturelles. En analysant des milliers de recettes,</span>
<span class="sd">            nous r√©v√©lons les combinaisons d&#39;ingr√©dients qui apparaissent fr√©quemment ensemble.</span>

<span class="sd">            **Questions centrales :** Quels ingr√©dients sont naturellement associ√©s ? Existe-t-il des</span>
<span class="sd">            familles d&#39;ingr√©dients distinctes ? Comment les ingr√©dients se regroupent-ils en fonction</span>
<span class="sd">            de leurs profils d&#39;utilisation ?</span>

<span class="sd">            **Approche :**</span>
<span class="sd">            - **√âtapes 1-2 (pr√©calcul√©es √† froid)** : Analyse NLP des listes d&#39;ingr√©dients et construction</span>
<span class="sd">              d&#39;une matrice de co-occurrence 300√ó300</span>
<span class="sd">            - **√âtapes 3-4 (temps r√©el)** : Clustering automatique par K-means et visualisation en 2D par t-SNE</span>

<span class="sd">            **Probl√©matique :** Dans un espace culinaire o√π des milliers d&#39;ingr√©dients peuvent √™tre</span>
<span class="sd">            combin√©s, comment identifier automatiquement les groupes d&#39;ingr√©dients qui partagent des</span>
<span class="sd">            contextes d&#39;utilisation similaires ?</span>


<span class="sd">            **üí° Optimisation** : Les √©tapes 1-2 sont pr√©calcul√©es pour acc√©l√©rer l&#39;analyse. Vous ajustez</span>
<span class="sd">            le nombre d&#39;ingr√©dients (40-300) et de clusters (3-20) en temps r√©el.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Sidebar</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_sidebar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameters: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Charger la matrice pr√©calcul√©e</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_cooccurrence_matrix</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">full_matrix</span><span class="p">,</span> <span class="n">ingredients_list</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># V√©rifier si les param√®tres ont chang√©</span>
        <span class="n">params_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;last_params&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;last_params&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">last</span><span class="p">[</span><span class="s2">&quot;n_ingredients&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_ingredients&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">last</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">last</span><span class="p">[</span><span class="s2">&quot;tsne_perplexity&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tsne_perplexity&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">params_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># D√©cider si on lance l&#39;analyse</span>
        <span class="n">should_analyze</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;analyze_button&quot;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="s2">&quot;clusters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span>
            <span class="ow">or</span> <span class="n">params_changed</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">should_analyze</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Running analysis: n_ingredients=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_ingredients&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, n_clusters=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_clusters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Analyse en cours...&quot;</span><span class="p">):</span>
                <span class="c1"># S√©lectionner les top N ingr√©dients</span>
                <span class="n">matrix</span><span class="p">,</span> <span class="n">ingredient_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_top_ingredients</span><span class="p">(</span>
                    <span class="n">full_matrix</span><span class="p">,</span> <span class="n">ingredients_list</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_ingredients&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># Clustering</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_clustering</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">])</span>

                <span class="c1"># t-SNE</span>
                <span class="n">tsne_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_tsne</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tsne_perplexity&quot;</span><span class="p">])</span>

                <span class="c1"># Sauvegarder dans session</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;ingredient_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ingredient_names</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clusters</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;tsne_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne_data</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;last_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Afficher les r√©sultats si disponibles</span>
        <span class="k">if</span> <span class="s2">&quot;clusters&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;matrix&quot;</span><span class="p">]</span>
            <span class="n">ingredient_names</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;ingredient_names&quot;</span><span class="p">]</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span>
            <span class="n">tsne_data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;tsne_data&quot;</span><span class="p">]</span>

            <span class="c1"># M√©triques</span>
            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;üìä Matrice source&quot;</span><span class="p">,</span> <span class="s2">&quot;300x300&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;ü•ò Ingr√©dients analys√©s&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">col3</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="s2">&quot;üéØ Clusters cr√©√©s&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_clusters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># √âTAPES</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_1_preprocessing</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_2_cooccurrence</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_3_clustering</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_render_step_4_visualization</span><span class="p">(</span><span class="n">tsne_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_render_conclusion</span><span class="p">(</span><span class="n">ingredient_names</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;n_clusters&quot;</span><span class="p">])</span>

            <span class="c1"># Statistiques sidebar</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render_sidebar_statistics</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">ingredient_names</span><span class="p">)</span>

        <span class="c1"># Footer</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span>
            <span class="s2">&quot;üí° **Configuration** : Ajustez les param√®tres dans la sidebar pour explorer diff√©rentes configurations.&quot;</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2025, William.</p>
  </div>

  Compil√© avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">th√®me</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>